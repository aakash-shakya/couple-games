<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playing LoverPlay!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//unpkg.com/alpinejs" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/style.css">
     <style>
        body { background: linear-gradient(135deg, #FFC0CB 0%, #C8A2C8 100%); }
         .cursive { font-family: 'Pacifico', cursive; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 text-purple-900"
      x-data="playGame()">

    <div class="bg-white/90 p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full text-center">
        <h1 class="cursive text-4xl text-pink-600 mb-4 drop-shadow">LoverPlay</h1>
        <p class="text-sm mb-1">Room Code: <strong x-text="roomCode"></strong></p>
        <p class="text-sm mb-4">You are Player <strong x-text="playerNumber"></strong></p>

        <div class="border-t border-b border-purple-200 py-6 my-6">
            <h2 class="text-2xl font-semibold mb-3" x-text="turnStatus">Waiting for game...</h2>
            <div id="challenge-text" class="text-lg text-purple-800 fade-in" x-html="currentChallenge || 'Waiting for the next challenge...'">
                <!-- Challenge text appears here -->
            </div>
        </div>

        <!-- Action Button (only shown when it's your turn) -->
        <template x-if="isMyTurn">
            <button @click="performAction"
                    class="w-full px-6 py-3 mt-4 bg-green-500 text-white text-lg font-semibold rounded-full shadow-lg hover:bg-green-600 transition duration-300 ease-in-out transform hover:scale-105">
                Done! Next Challenge ðŸ‘‰
            </button>
        </template>

         <!-- Status Messages -->
        <p x-show="status" x-text="status" class="text-green-700 mt-4"></p>
        <p x-show="error" x-text="error" class="text-red-600 mt-4"></p>
        <p x-show="partnerStatus" x-text="partnerStatus" class="text-blue-600 mt-4 italic"></p>

    </div>

     <footer class="mt-8 text-white text-sm opacity-75">
        <a href="/" class="hover:text-pink-200 transition">Leave Game</a>
    </footer>

    <script>
        function playGame() {
            return {
                socket: null,
                roomCode: '',
                playerNumber: null,
                gameType: null,
                currentChallenge: '',
                isMyTurn: false,
                turnStatus: 'Connecting...',
                status: '',
                error: '',
                partnerStatus: '', // Messages like 'Partner left', 'Partner completed task'

                init() {
                    // Extract room code from URL path
                    const pathSegments = window.location.pathname.split('/');
                    this.roomCode = pathSegments[pathSegments.length - 1];

                    if (!this.roomCode) {
                        this.error = "No room code specified!";
                        return;
                    }

                    this.socket = io();

                    this.socket.on('connect', () => {
                        console.log('Connected to game server');
                        this.turnStatus = 'Connected. Waiting for game start...';
                        // Re-join room implicitly or explicitly if needed after reconnect
                        // For simplicity, we assume the server handles session continuity
                        // Or we might need to emit a 'rejoin' event with roomCode
                    });

                    // Need to know which player number this client is.
                    // This info is usually received during the 'join' or 'create' phase.
                    // We'll try to retrieve it from localStorage or ask the server.
                    // For now, let's assume it might be set by a previous page or needs fetching.
                    // A robust way would be for the server to confirm player number upon connection to this page.
                    // Let's add a temporary way to ask the server.
                    this.socket.emit('getPlayerNumber', { roomCode: this.roomCode }); // Custom event needed on server

                     this.socket.on('playerNumberInfo', ({ number }) => {
                         if (number) {
                            this.playerNumber = number;
                            console.log(`Confirmed as Player ${this.playerNumber}`);
                         } else {
                             // Handle case where server doesn't know this socket in this room
                             this.error = "Could not verify player status. Try rejoining.";
                             // Maybe redirect: window.location.href = '/join.html';
                         }
                     });


                    this.socket.on('gameStarted', ({ gameType }) => {
                        console.log(`Game started: ${gameType}`);
                        this.gameType = gameType;
                        this.status = `Game started: ${gameType}!`;
                        this.error = '';
                        this.partnerStatus = '';
                    });

                    this.socket.on('yourTurn', ({ challenge }) => {
                        console.log('My turn:', challenge);
                        this.currentChallenge = this.formatChallenge(challenge);
                        this.isMyTurn = true;
                        this.turnStatus = "ðŸ’– Your Turn! ðŸ’–";
                        this.status = '';
                        this.error = '';
                        this.partnerStatus = '';
                        this.triggerFadeIn();
                    });

                    this.socket.on('opponentTurn', ({ challenge }) => {
                        console.log("Opponent's turn:", challenge);
                        this.currentChallenge = this.formatChallenge(challenge);
                        this.isMyTurn = false;
                        this.turnStatus = "Partner's Turn... ðŸ¤”";
                        this.status = '';
                        this.error = '';
                        this.partnerStatus = '';
                         this.triggerFadeIn();
                    });

                     this.socket.on('opponentAction', ({ action }) => {
                        console.log('Opponent action:', action);
                        // Display something subtle indicating partner acted
                        this.partnerStatus = `Partner completed the task! âœ¨`;
                        // Clear after a few seconds
                        setTimeout(() => this.partnerStatus = '', 3000);
                    });


                    this.socket.on('playerLeft', ({ message }) => {
                        console.log('Partner left:', message);
                        this.error = message;
                        this.turnStatus = 'Game Over';
                        this.isMyTurn = false;
                        this.currentChallenge = 'Your partner has left the room. ðŸ˜¢';
                    });

                    this.socket.on('error', ({ message }) => {
                        console.error('Game error:', message);
                        this.error = message;
                        // Decide if game should stop based on error type
                    });

                    this.socket.on('disconnect', () => {
                        console.log('Disconnected from server');
                        this.error = 'Connection lost. Attempting to reconnect...';
                        this.turnStatus = 'Disconnected';
                        // Handle reconnection logic if needed
                    });
                },

                performAction() {
                    if (!this.isMyTurn) return;
                    console.log('Performing action (e.g., completed challenge)');
                    this.status = 'Sending confirmation...';
                    // Simple action confirmation, could be expanded
                    this.socket.emit('playerAction', { action: 'completed' });
                    this.isMyTurn = false; // Visually disable button immediately
                    this.turnStatus = "Waiting for next challenge...";
                },

                formatChallenge(text) {
                    // Basic formatting: replace newlines with <br>
                    // Add more complex formatting/parsing if needed
                    return text.replace(/\n/g, '<br>');
                },

                triggerFadeIn() {
                    // Re-trigger fade-in animation for the challenge text
                    const el = document.getElementById('challenge-text');
                    if (el) {
                        el.classList.remove('fade-in');
                        // void el.offsetWidth; // Trigger reflow
                        requestAnimationFrame(() => {
                             el.classList.add('fade-in');
                        });
                    }
                }
            }
        }

        // Add a way for the server to respond to 'getPlayerNumber'
        // This needs a corresponding handler on the server side in sockets.js
        // Example server-side handler (add inside io.on('connection', ...)):
        /*
        socket.on('getPlayerNumber', ({ roomCode }) => {
            const room = getRoom(roomCode);
            let number = null;
            if (room) {
                const index = room.players.indexOf(socket.id);
                if (index !== -1) {
                    number = index + 1; // 1 or 2
                }
            }
            socket.emit('playerNumberInfo', { number });
        });
        */
    </script>

</body>
</html>
