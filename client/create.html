<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Room - LoverPlay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//unpkg.com/alpinejs" defer></script>
     <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/style.css">
     <style>
        body { background: linear-gradient(135deg, #FFC0CB 0%, #C8A2C8 100%); }
         .cursive { font-family: 'Pacifico', cursive; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 text-purple-900"
      x-data="createRoom()">

    <a href="/" class="absolute top-4 left-4 text-white hover:text-pink-200 transition">&larr; Back Home</a>

    <h1 class="cursive text-5xl text-white mb-8 drop-shadow-lg">Create a Room</h1>

    <div class="bg-white/80 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
        <template x-if="!roomCode">
            <button @click="requestNewRoom"
                    class="w-full px-6 py-3 bg-pink-500 text-white text-lg font-semibold rounded-full shadow-lg hover:bg-pink-600 transition duration-300 ease-in-out transform hover:scale-105">
                Generate Room Code ‚ú®
            </button>
        </template>

        <template x-if="roomCode">
            <div>
                <p class="text-lg mb-2">Share this code with your partner:</p>
                <div class="bg-purple-100 border-2 border-purple-300 rounded-lg p-4 mb-4">
                    <strong class="text-3xl font-mono tracking-widest text-purple-700" x-text="roomCode"></strong>
                </div>
                <button @click="copyCode"
                        class="w-full px-6 py-2 mb-4 bg-purple-500 text-white text-sm rounded-full shadow hover:bg-purple-600 transition">
                    Copy Code
                </button>
                <p class="text-md italic mb-4">Waiting for your partner to join...</p>
                <div class="animate-pulse text-pink-600">üíñ</div>
                 <!-- Game Type Selection (Shown after partner joins) -->
                <template x-if="gameReady">
                    <div class="mt-6 border-t pt-4">
                        <h2 class="text-xl font-semibold mb-3">Choose Your Game Mood:</h2>
                        <div class="space-y-3">
                             <button @click="startGame('basic')" class="w-full py-2 px-4 bg-green-400 hover:bg-green-500 text-white rounded-lg transition">üòä Basic Romantic</button>
                             <button @click="startGame('fun')" class="w-full py-2 px-4 bg-yellow-400 hover:bg-yellow-500 text-white rounded-lg transition">üòÇ Fun & Flirty</button>
                             <button @click="startGame('spicy')" class="w-full py-2 px-4 bg-red-400 hover:bg-red-500 text-white rounded-lg transition">üå∂Ô∏è Spicy & Intimate</button>
                             <button @click="startGame('ai')" class="w-full py-2 px-4 bg-blue-400 hover:bg-blue-500 text-white rounded-lg transition">ü§ñ AI Surprise!</button>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <p x-show="error" x-text="error" class="text-red-600 mt-4"></p>
        <p x-show="status" x-text="status" class="text-green-600 mt-4"></p>
    </div>

    <script>
        function createRoom() {
            return {
                socket: null,
                roomCode: null,
                error: '',
                status: '',
                playerNumber: null,
                gameReady: false, // Flag to show game type selection
                init() {
                    // Connect to Socket.IO server
                    // Ensure this matches your server address if not localhost
                    this.socket = io();

                    this.socket.on('connect', () => {
                        console.log('Connected to server');
                        this.status = 'Connected. Ready to create room.';
                        this.error = '';
                    });

                    this.socket.on('roomCreated', ({ roomCode, playerNumber }) => {
                        console.log('Room created:', roomCode);
                        this.roomCode = roomCode;
                        this.playerNumber = playerNumber;
                        this.status = 'Room created! Waiting for partner...';
                        this.error = '';
                    });

                    this.socket.on('gameReady', ({ roomCode: serverRoomCode }) => {
                         if (this.roomCode === serverRoomCode) {
                            console.log('Partner joined! Game is ready.');
                            this.status = 'Partner joined! Choose a game type.';
                            this.gameReady = true; // Show game type buttons
                         }
                    });

                     this.socket.on('gameStarted', ({ gameType }) => {
                        console.log(`Game started with type: ${gameType}`);
                        // Redirect to the play screen
                        window.location.href = `/play/${this.roomCode}`;
                    });


                    this.socket.on('error', ({ message }) => {
                        console.error('Server error:', message);
                        this.error = message;
                        this.status = '';
                    });

                    this.socket.on('disconnect', () => {
                        console.log('Disconnected from server');
                        this.error = 'Disconnected. Please refresh.';
                        this.status = '';
                        this.roomCode = null; // Reset state on disconnect
                        this.gameReady = false;
                    });
                },
                requestNewRoom() {
                    this.status = 'Creating room...';
                    this.error = '';
                    this.socket.emit('createRoom');
                },
                copyCode() {
                    if (!this.roomCode) return;
                    navigator.clipboard.writeText(this.roomCode)
                        .then(() => {
                            this.status = 'Code copied!';
                            setTimeout(() => {
                                if (this.gameReady) {
                                    this.status = 'Partner joined! Choose a game type.';
                                } else if (this.roomCode) {
                                    this.status = 'Room created! Waiting for partner...';
                                }
                            }, 1500);
                        })
                        .catch(err => {
                            console.error('Failed to copy code:', err);
                            this.error = 'Could not copy code.';
                        });
                },
                 startGame(gameType) {
                    if (!this.roomCode || !this.gameReady) return;
                    console.log(`Requesting to start game type: ${gameType}`);
                    this.status = `Starting ${gameType} game...`;
                    this.socket.emit('startGame', { gameType });
                }
            }
        }
    </script>

</body>
</html>
